import React, { useState, useEffect, useRef } from 'react';
import { 
  Dumbbell, Lock, Play, Plus, Trash2, CheckCircle2, 
  Settings, X, ChevronRight, ShieldCheck, Timer, Pause, 
  ArrowLeft, Search, Layers, Activity, Zap, Monitor, 
  LayoutGrid, List, Volume2, VolumeX, SkipForward, RotateCcw
} from 'lucide-react';

// --- DATA: CATÁLOGO DE EJERCICIOS MASIVO (100% ESPAÑOL) ---
const EXERCISE_CATALOG = [
  // --- PECTORALES (PECHO) ---
  { id: 'ch1', name: 'Flexiones Clásicas', muscle: 'chest', difficulty: 'Intermedio', description: 'Manos a la anchura de los hombros. Cuerpo recto. Baja hasta rozar el suelo.' },
  { id: 'ch2', name: 'Flexiones Diamante', muscle: 'chest', difficulty: 'Avanzado', description: 'Manos juntas en diamante. Enfoque tríceps/pecho interior.' },
  { id: 'ch3', name: 'Flexiones Declinadas', muscle: 'chest', difficulty: 'Intermedio', description: 'Pies elevados en silla. Enfoque pectoral superior.' },
  { id: 'ch4', name: 'Flexiones Inclinadas', muscle: 'chest', difficulty: 'Principiante', description: 'Manos en superficie elevada. Menor carga.' },
  { id: 'ch5', name: 'Flexiones Arqueras', muscle: 'chest', difficulty: 'Experto', description: 'Baja a un lado extendiendo el otro brazo. Alterna.' },
  { id: 'ch6', name: 'Fondos en Paralelas', muscle: 'chest', difficulty: 'Avanzado', description: 'Usa sillas o barras. Baja hasta 90 grados.' },
  { id: 'ch7', name: 'Flexiones con Palmada', muscle: 'chest', difficulty: 'Experto', description: 'Empuje explosivo con palmada en el aire.' },
  { id: 'ch8', name: 'Flexiones Spiderman', muscle: 'chest', difficulty: 'Avanzado', description: 'Rodilla al codo al bajar. Alterna.' },
  { id: 'ch9', name: 'Aperturas en Suelo', muscle: 'chest', difficulty: 'Avanzado', description: 'Desliza manos hacia afuera (usando trapos).' },
  // >> Mancuernas Pecho
  { id: 'db_ch1', name: 'Press Banca (Mancuernas)', muscle: 'chest', difficulty: 'Intermedio', description: 'Tumbado en suelo/banco, empuja las mancuernas hacia arriba.' },
  { id: 'db_ch2', name: 'Aperturas (Mancuernas)', muscle: 'chest', difficulty: 'Intermedio', description: 'Tumbado, abre brazos en cruz con codos semiflexionados.' },
  { id: 'db_ch3', name: 'Pullover (Mancuerna)', muscle: 'chest', difficulty: 'Intermedio', description: 'Tumbado, lleva una mancuerna con dos manos hacia atrás de la cabeza.' },

  // --- ESPALDA (DORSALES) ---
  { id: 'bk1', name: 'Dominadas Pronas', muscle: 'back', difficulty: 'Avanzado', description: 'Palmas al frente. Sube barbilla. Ensancha espalda.' },
  { id: 'bk2', name: 'Dominadas Supinas', muscle: 'back', difficulty: 'Intermedio', description: 'Palmas hacia ti. Enfoque bíceps/dorsales.' },
  { id: 'bk3', name: 'Remo Invertido', muscle: 'back', difficulty: 'Intermedio', description: 'Bajo una mesa, tracciona el pecho hacia el borde.' },
  { id: 'bk4', name: 'Superman', muscle: 'back', difficulty: 'Principiante', description: 'Boca abajo, eleva extremidades. Sostén.' },
  { id: 'bk5', name: 'Ángeles Invertidos', muscle: 'back', difficulty: 'Principiante', description: 'Boca abajo, "nadas" sin tocar el suelo.' },
  { id: 'bk6', name: 'Remo Marco Puerta', muscle: 'back', difficulty: 'Principiante', description: 'Agarra marco, inclínate y tracciona.' },
  { id: 'bk7', name: 'Buenos días', muscle: 'back', difficulty: 'Intermedio', description: 'Inclina torso adelante, espalda recta. Lumbares.' },
  { id: 'bk8', name: 'Wall Slides', muscle: 'back', difficulty: 'Principiante', description: 'Espalda en pared, desliza brazos arriba/abajo.' },
  // >> Mancuernas Espalda
  { id: 'db_bk1', name: 'Remo a una mano (Manc)', muscle: 'back', difficulty: 'Intermedio', description: 'Apoya rodilla en banco, tracciona mancuerna a la cadera.' },
  { id: 'db_bk2', name: 'Remo Inclinado (Manc)', muscle: 'back', difficulty: 'Avanzado', description: 'Inclina torso 45º, tracciona ambas mancuernas simultáneamente.' },
  { id: 'db_bk3', name: 'Peso Muerto (Manc)', muscle: 'back', difficulty: 'Intermedio', description: 'Baja mancuernas rozando piernas, espalda recta.' },
  { id: 'db_bk4', name: 'Encogimientos (Trapecio)', muscle: 'back', difficulty: 'Principiante', description: 'De pie con mancuernas, sube hombros a orejas.' },

  // --- PIERNAS (CUÁDRICEPS / FEMORALES) ---
  { id: 'lg1', name: 'Sentadilla (Squat)', muscle: 'legs', difficulty: 'Principiante', description: 'Baja cadera atrás. Espalda recta.' },
  { id: 'lg2', name: 'Zancadas (Lunges)', muscle: 'legs', difficulty: 'Intermedio', description: 'Paso al frente, baja rodilla trasera. Alterna.' },
  { id: 'lg3', name: 'Sentadilla Búlgara', muscle: 'legs', difficulty: 'Avanzado', description: 'Un pie apoyado atrás. Baja con una pierna.' },
  { id: 'lg4', name: 'Sentadilla Pistol', muscle: 'legs', difficulty: 'Experto', description: 'Sentadilla completa a una pierna. Equilibrio.' },
  { id: 'lg5', name: 'Sentadilla Sumo', muscle: 'legs', difficulty: 'Intermedio', description: 'Piernas abiertas. Enfoque aductores.' },
  { id: 'lg6', name: 'Puente de Glúteo', muscle: 'legs', difficulty: 'Principiante', description: 'Boca arriba, eleva cadera apretando glúteos.' },
  { id: 'lg7', name: 'Puente 1 Pierna', muscle: 'legs', difficulty: 'Intermedio', description: 'Igual que puente, una pierna al aire.' },
  { id: 'lg8', name: 'Elevación Talones', muscle: 'legs', difficulty: 'Principiante', description: 'Sube a puntillas. Gemelos.' },
  { id: 'lg9', name: 'Sentadilla Pared', muscle: 'legs', difficulty: 'Intermedio', description: 'Isométrico sentado en el aire contra pared.' },
  { id: 'lg10', name: 'Cossack Squat', muscle: 'legs', difficulty: 'Avanzado', description: 'Baja lateralmente sobre una pierna.' },
  // >> Mancuernas Piernas
  { id: 'db_lg1', name: 'Sentadilla Goblet (Copa)', muscle: 'legs', difficulty: 'Intermedio', description: 'Sostén mancuerna al pecho y baja profundo.' },
  { id: 'db_lg2', name: 'Zancadas con Carga', muscle: 'legs', difficulty: 'Intermedio', description: 'Zancadas sosteniendo mancuernas a los lados.' },
  { id: 'db_lg3', name: 'Peso Muerto Rumano', muscle: 'legs', difficulty: 'Avanzado', description: 'Rodillas semiflexionadas, baja sintiendo isquios.' },
  { id: 'db_lg4', name: 'Elevación Talones (Carga)', muscle: 'legs', difficulty: 'Intermedio', description: 'Puntillas con mancuernas en manos.' },

  // --- HOMBROS (DELTOIDES) ---
  { id: 'sh1', name: 'Flexiones Pike', muscle: 'shoulders', difficulty: 'Intermedio', description: 'Cuerpo en V invertida. Baja cabeza al suelo.' },
  { id: 'sh2', name: 'Pike Elevadas', muscle: 'shoulders', difficulty: 'Avanzado', description: 'Pies en silla. Mayor carga en hombros.' },
  { id: 'sh3', name: 'Caminata de Pared', muscle: 'shoulders', difficulty: 'Experto', description: 'Trepa la pared con pies hasta vertical.' },
  { id: 'sh4', name: 'Elevaciones Lat. (Botellas)', muscle: 'shoulders', difficulty: 'Principiante', description: 'Con botellas. Levanta brazos lateralmente.' },
  { id: 'sh5', name: 'Plancha Hombros', muscle: 'shoulders', difficulty: 'Intermedio', description: 'En plancha, toca hombro contrario.' },
  { id: 'sh6', name: 'Y-T-W-L', muscle: 'shoulders', difficulty: 'Intermedio', description: 'Boca abajo, forma letras con brazos.' },
  // >> Mancuernas Hombros
  { id: 'db_sh1', name: 'Press Militar (Manc)', muscle: 'shoulders', difficulty: 'Intermedio', description: 'Sentado/pie, empuja mancuernas al techo.' },
  { id: 'db_sh2', name: 'Elev. Laterales (Manc)', muscle: 'shoulders', difficulty: 'Intermedio', description: 'Levanta brazos a los lados hasta altura hombros.' },
  { id: 'db_sh3', name: 'Pájaros/Vuelos (Manc)', muscle: 'shoulders', difficulty: 'Intermedio', description: 'Inclina torso, abre brazos enfocando posterior.' },
  { id: 'db_sh4', name: 'Press Arnold', muscle: 'shoulders', difficulty: 'Avanzado', description: 'Press militar rotando muñecas al subir.' },

  // --- BRAZOS (BÍCEPS / TRÍCEPS) ---
  { id: 'ar1', name: 'Fondos Tríceps', muscle: 'arms', difficulty: 'Principiante', description: 'Manos en silla tras ti. Flexiona codos.' },
  { id: 'ar2', name: 'Extensión Suelo', muscle: 'arms', difficulty: 'Intermedio', description: 'Plancha antebrazos, empuja para estirar.' },
  { id: 'ar3', name: 'Curl Bíceps (Toalla)', muscle: 'arms', difficulty: 'Intermedio', description: 'Usa toalla/marco para resistencia manual.' },
  { id: 'ar4', name: 'Chin-up Isométrico', muscle: 'arms', difficulty: 'Intermedio', description: 'Cuélgate barbilla arriba. Aguanta.' },
  { id: 'ar5', name: 'Flexiones Cerradas', muscle: 'arms', difficulty: 'Intermedio', description: 'Manos pegadas al torso. Tríceps.' },
  // >> Mancuernas Brazos
  { id: 'db_ar1', name: 'Curl Bíceps (Manc)', muscle: 'arms', difficulty: 'Principiante', description: 'Flexiona codos, palmas arriba.' },
  { id: 'db_ar2', name: 'Curl Martillo', muscle: 'arms', difficulty: 'Principiante', description: 'Curl con palmas enfrentadas (neutro).' },
  { id: 'db_ar3', name: 'Copa Tríceps', muscle: 'arms', difficulty: 'Intermedio', description: 'Sentado, extiende mancuerna tras nuca.' },
  { id: 'db_ar4', name: 'Patada Tríceps', muscle: 'arms', difficulty: 'Intermedio', description: 'Inclina torso, extiende brazo atrás.' },
  { id: 'db_ar5', name: 'Curl Concentrado', muscle: 'arms', difficulty: 'Intermedio', description: 'Codo en muslo interior, aisla el bíceps.' },

  // --- ABDOMEN (CORE) ---
  { id: 'co1', name: 'Plancha (Plank)', muscle: 'core', difficulty: 'Intermedio', description: 'Antebrazos. Cuerpo recto y tenso.' },
  { id: 'co2', name: 'Crunch', muscle: 'core', difficulty: 'Principiante', description: 'Eleva omóplatos contrayendo abdomen.' },
  { id: 'co3', name: 'Elevación Piernas', muscle: 'core', difficulty: 'Intermedio', description: 'Sube piernas rectas a 90 grados.' },
  { id: 'co4', name: 'Russian Twists', muscle: 'core', difficulty: 'Intermedio', description: 'Sentado en V, gira torso lado a lado.' },
  { id: 'co5', name: 'Bicho Muerto', muscle: 'core', difficulty: 'Principiante', description: 'Coordina brazo/pierna contraria.' },
  { id: 'co6', name: 'Plancha Lateral', muscle: 'core', difficulty: 'Intermedio', description: 'Sobre un antebrazo. Alinea cuerpo.' },
  { id: 'co7', name: 'Hollow Body', muscle: 'core', difficulty: 'Avanzado', description: 'Forma "banana" con cuerpo. Isométrico.' },
  { id: 'co8', name: 'Tijeras', muscle: 'core', difficulty: 'Intermedio', description: 'Boca arriba, cruza piernas.' },
  // >> Mancuernas Core
  { id: 'db_co1', name: 'Russian Twist (Carga)', muscle: 'core', difficulty: 'Avanzado', description: 'Giros rusos sosteniendo mancuerna.' },
  { id: 'db_co2', name: 'Paseo Granjero (1 lado)', muscle: 'core', difficulty: 'Intermedio', description: 'Camina sosteniendo peso solo en un lado. Estabilidad.' },

  // --- CARDIO / HIIT / CUERPO COMPLETO ---
  { id: 'ca1', name: 'Burpees', muscle: 'cardio', difficulty: 'Avanzado', description: 'Sentadilla -> Plancha -> Flexión -> Salto.' },
  { id: 'ca2', name: 'Jumping Jacks', muscle: 'cardio', difficulty: 'Principiante', description: 'Saltos abriendo piernas/brazos.' },
  { id: 'ca3', name: 'Mountain Climbers', muscle: 'cardio', difficulty: 'Intermedio', description: 'Rodillas al pecho rápido en plancha.' },
  { id: 'ca4', name: 'Salto Cuerda', muscle: 'cardio', difficulty: 'Principiante', description: 'Simula saltar cuerda rápido.' },
  { id: 'ca5', name: 'Sentadilla Salto', muscle: 'cardio', difficulty: 'Avanzado', description: 'Sentadilla con despegue explosivo.' },
  { id: 'ca6', name: 'High Knees', muscle: 'cardio', difficulty: 'Intermedio', description: 'Corre sitio rodillas altas.' },
  { id: 'ca7', name: 'Walkouts', muscle: 'cardio', difficulty: 'Intermedio', description: 'Camina con manos hasta plancha y vuelve.' },
  // >> Mancuernas Cardio/FullBody
  { id: 'db_ca1', name: 'Thrusters (Manc)', muscle: 'cardio', difficulty: 'Experto', description: 'Sentadilla profunda + Press militar al subir. Explosivo.' },
  { id: 'db_ca2', name: 'Snatch (Manc)', muscle: 'cardio', difficulty: 'Experto', description: 'Eleva mancuerna desde suelo a techo en un movimiento.' }
];

const MUSCLE_GROUPS = [
  { id: 'chest', name: 'Pecho', icon: Activity, desc: 'Empuje' },
  { id: 'back', name: 'Espalda', icon: Layers, desc: 'Tracción' },
  { id: 'legs', name: 'Piernas', icon: LayoutGrid, desc: 'Potencia' },
  { id: 'shoulders', name: 'Hombros', icon: Dumbbell, desc: 'Deltoides' },
  { id: 'arms', name: 'Brazos', icon: Zap, desc: 'Bíceps/Tríceps' },
  { id: 'core', name: 'Abdomen', icon: ShieldCheck, desc: 'Core' },
  { id: 'cardio', name: 'Cardio', icon: Activity, desc: 'Quema' },
];

// --- COMPONENTES AUXILIARES ---

const Modal = ({ isOpen, onClose, title, children }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
      <div className="w-full max-w-sm bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl animate-in fade-in zoom-in duration-200">
        <div className="flex justify-between items-center p-4 border-b border-neutral-800">
          <h3 className="text-base font-bold text-white tracking-tight">{title}</h3>
          <button onClick={onClose} className="text-neutral-500 hover:text-white transition-colors">
            <X size={20} />
          </button>
        </div>
        <div className="p-4">
          {children}
        </div>
      </div>
    </div>
  );
};

// --- FUNCIÓN HELPER TTS ---
const speak = (text) => {
    if (!('speechSynthesis' in window)) return;
    
    // Cancelar cualquier audio anterior para evitar cola
    window.speechSynthesis.cancel();

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'es-ES';
    utterance.rate = 1.0;
    utterance.pitch = 1.0;
    
    window.speechSynthesis.speak(utterance);
};

// --- APP PRINCIPAL ---

export default function App() {
  const [step, setStep] = useState('loading'); // loading, onboarding, builder, locked
  const [userData, setUserData] = useState({ name: '', password: '', securityQuestion: '', securityAnswer: '' });
  const [routine, setRoutine] = useState([]);
  
  // Estados UI
  const [showUnlockModal, setShowUnlockModal] = useState(false);
  const [showRecoveryModal, setShowRecoveryModal] = useState(false);
  const [workoutActive, setWorkoutActive] = useState(false);
  
  // Builder Navigation State
  const [mobileTab, setMobileTab] = useState('catalog'); // 'catalog' | 'routine'
  const [builderCategory, setBuilderCategory] = useState(null); 
  
  // Formularios temporales
  const [tempPassword, setTempPassword] = useState('');
  const [tempSecurityAnswer, setTempSecurityAnswer] = useState('');
  const [searchQuery, setSearchQuery] = useState('');

  // Carga inicial
  useEffect(() => {
    const savedData = localStorage.getItem('fit_app_mobile_v5_data');
    if (savedData) {
      const parsed = JSON.parse(savedData);
      setUserData(parsed.userData);
      setRoutine(parsed.routine);
      if (parsed.userData.password) {
        setStep('locked');
      } else if (parsed.userData.name) {
        setStep('builder');
      } else {
        setStep('onboarding');
      }
    } else {
      setStep('onboarding');
    }
  }, []);

  useEffect(() => {
    if (userData.name) {
      localStorage.setItem('fit_app_mobile_v5_data', JSON.stringify({ userData, routine }));
    }
  }, [userData, routine]);

  // Handlers
  const handleOnboarding = (e) => {
    e.preventDefault();
    if (userData.name.trim()) setStep('builder');
  };

  const addToRoutine = (exercise) => {
    const newItem = {
      ...exercise,
      uid: Date.now(),
      sets: 4,
      reps: 12,
      rest: 60,
      completed: false
    };
    setRoutine([...routine, newItem]);
    // Feedback visual opcional o vibración
    if (window.navigator && window.navigator.vibrate) navigator.vibrate(50);
  };

  const removeFromRoutine = (uid) => {
    setRoutine(routine.filter(item => item.uid !== uid));
  };

  const updateRoutineItem = (uid, field, value) => {
    setRoutine(routine.map(item => item.uid === uid ? { ...item, [field]: value } : item));
  };

  const handleLock = (e) => {
    e.preventDefault();
    if (userData.password && userData.securityQuestion && userData.securityAnswer) {
      setStep('locked');
      setBuilderCategory(null);
    }
  };

  const handleUnlock = (e) => {
    e.preventDefault();
    if (tempPassword === userData.password) {
      setStep('builder');
      setShowUnlockModal(false);
      setTempPassword('');
    } else {
      alert("Contraseña incorrecta");
    }
  };

  const handleRecovery = (e) => {
    e.preventDefault();
    if (tempSecurityAnswer.toLowerCase().trim() === userData.securityAnswer.toLowerCase().trim()) {
      const newPass = prompt("Ingresa nueva contraseña:");
      if (newPass) {
        setUserData({ ...userData, password: newPass });
        alert("Contraseña actualizada.");
        setShowRecoveryModal(false);
      }
    } else {
      alert("Respuesta incorrecta");
    }
  };

  // --- RENDERIZADO ---

  if (step === 'loading') return <div className="min-h-screen bg-black flex items-center justify-center text-white">Cargando...</div>;

  // 1. ONBOARDING
  if (step === 'onboarding') {
    return (
      <div className="min-h-screen bg-black text-white flex flex-col items-center justify-center p-6 relative overflow-hidden">
        <div className="absolute top-0 left-0 w-full h-full bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-neutral-900 via-black to-black opacity-60"></div>
        
        <div className="max-w-xs w-full relative z-10 animate-in fade-in slide-in-from-bottom-8 duration-700">
          <div className="w-20 h-20 bg-white rounded-2xl flex items-center justify-center text-black mb-6 mx-auto shadow-2xl">
            <Monitor size={40} />
          </div>
          <h1 className="text-3xl font-black text-center mb-2 tracking-tighter uppercase">Trainer Pro</h1>
          <p className="text-neutral-500 text-center mb-8 text-sm">Configura tu sistema de entrenamiento.</p>
          
          <form onSubmit={handleOnboarding} className="space-y-4">
            <div className="space-y-1">
              <label className="text-[10px] uppercase tracking-widest text-neutral-500 ml-1">Usuario</label>
              <input 
                type="text" 
                required
                placeholder="Tu nombre"
                className="w-full bg-neutral-900 border border-neutral-800 rounded-xl p-4 text-lg text-white placeholder-neutral-700 focus:outline-none focus:border-white focus:bg-neutral-800 transition-all"
                value={userData.name}
                onChange={(e) => setUserData({...userData, name: e.target.value})}
              />
            </div>
            <button className="w-full bg-white text-black font-bold text-base py-4 rounded-xl hover:bg-neutral-200 transition-transform active:scale-95 flex items-center justify-center gap-2">
              EMPEZAR <ChevronRight size={18} />
            </button>
          </form>
        </div>
      </div>
    );
  }

  // 2. CONSTRUCTOR (BUILDER)
  if (step === 'builder') {
    return (
      <div className="min-h-screen bg-black text-white flex flex-col lg:flex-row overflow-hidden pb-[60px] lg:pb-0">
        
        {/* --- PESTAÑA IZQUIERDA: CATÁLOGO --- */}
        <div className={`w-full lg:w-1/2 flex flex-col h-[calc(100vh-60px)] lg:h-screen lg:border-r border-neutral-900 relative ${mobileTab === 'catalog' ? 'flex' : 'hidden lg:flex'}`}>
          
          {/* Header Compacto */}
          <div className="px-4 py-3 border-b border-neutral-900 flex justify-between items-center bg-black/80 backdrop-blur-md sticky top-0 z-20 h-[60px]">
            <div className="flex items-center gap-2 truncate">
                {builderCategory && (
                    <button 
                        onClick={() => setBuilderCategory(null)}
                        className="bg-neutral-900 hover:bg-neutral-800 p-1.5 rounded-full transition-colors flex-shrink-0"
                    >
                        <ArrowLeft size={16} />
                    </button>
                )}
                <div className="truncate">
                    <h2 className="text-base font-bold tracking-tight uppercase truncate">
                        {builderCategory ? MUSCLE_GROUPS.find(g => g.id === builderCategory)?.name : 'Catálogo'}
                    </h2>
                </div>
            </div>
            {!builderCategory && (
                 <div className="relative flex-shrink-0 ml-2">
                    <Search className="absolute left-2.5 top-1/2 -translate-y-1/2 text-neutral-500" size={12} />
                    <input 
                        type="text" 
                        placeholder="Buscar..."
                        className="bg-neutral-900 border border-neutral-800 rounded-full pl-8 pr-3 py-1.5 text-xs focus:border-white outline-none w-28 focus:w-40 transition-all"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                    />
                 </div>
            )}
          </div>

          {/* Contenido Scrolleable */}
          <div className="flex-1 overflow-y-auto p-3 bg-black">
            
            {/* GRID CATEGORÍAS (Compacto) */}
            {!builderCategory && !searchQuery && (
                <div className="grid grid-cols-2 gap-2 animate-in fade-in duration-300">
                    {MUSCLE_GROUPS.map(group => (
                        <button 
                            key={group.id}
                            onClick={() => setBuilderCategory(group.id)}
                            className="bg-neutral-900/50 border border-neutral-900 p-3 rounded-lg flex flex-col items-center text-center gap-2 active:bg-neutral-800 transition-colors"
                        >
                            <div className="w-10 h-10 bg-neutral-900 rounded-full flex items-center justify-center text-white border border-neutral-800">
                                <group.icon size={18} />
                            </div>
                            <div>
                                <h3 className="font-bold text-sm text-white leading-tight">{group.name}</h3>
                                <p className="text-[10px] text-neutral-500">{group.desc}</p>
                            </div>
                        </button>
                    ))}
                </div>
            )}

            {/* LISTA DE EJERCICIOS (Compacta) */}
            {(builderCategory || searchQuery) && (
                <div className="space-y-2 pb-4 animate-in slide-in-from-right-4 duration-300">
                    {EXERCISE_CATALOG.filter(ex => {
                        if (searchQuery) return ex.name.toLowerCase().includes(searchQuery.toLowerCase()) || ex.muscle.includes(searchQuery.toLowerCase());
                        return ex.muscle === builderCategory;
                    }).map(exercise => (
                        <div key={exercise.id} className="bg-neutral-900/30 border border-neutral-900 p-3 rounded-lg flex justify-between items-center gap-3 active:border-neutral-700">
                            <div className="flex-1 min-w-0">
                                <div className="flex items-center gap-2 mb-1">
                                    <h3 className="font-bold text-white text-sm truncate">{exercise.name}</h3>
                                    {searchQuery && (
                                        <span className="text-[9px] uppercase bg-neutral-950 px-1.5 py-0.5 rounded text-neutral-500 border border-neutral-900 flex-shrink-0">
                                            {MUSCLE_GROUPS.find(g => g.id === exercise.muscle)?.name}
                                        </span>
                                    )}
                                </div>
                                <div className="flex items-center gap-2">
                                    <span className={`text-[9px] uppercase font-bold px-1.5 py-0.5 rounded border ${
                                        exercise.difficulty === 'Principiante' ? 'text-green-500 border-green-900/30' :
                                        exercise.difficulty === 'Intermedio' ? 'text-yellow-500 border-yellow-900/30' :
                                        'text-red-500 border-red-900/30'
                                    }`}>
                                        {exercise.difficulty}
                                    </span>
                                    <p className="text-xs text-neutral-500 truncate">{exercise.description}</p>
                                </div>
                            </div>
                            <button 
                                onClick={() => addToRoutine(exercise)}
                                className="w-9 h-9 rounded-full bg-white text-black flex items-center justify-center hover:bg-neutral-200 active:scale-90 flex-shrink-0 shadow-lg"
                            >
                                <Plus size={18} />
                            </button>
                        </div>
                    ))}
                    
                    {EXERCISE_CATALOG.filter(ex => searchQuery ? ex.name.toLowerCase().includes(searchQuery.toLowerCase()) : ex.muscle === builderCategory).length === 0 && (
                        <div className="text-center py-8 text-neutral-600 text-sm">
                            Sin resultados.
                        </div>
                    )}
                </div>
            )}
          </div>
        </div>

        {/* --- PESTAÑA DERECHA: RUTINA --- */}
        <div className={`w-full lg:w-1/2 flex flex-col h-[calc(100vh-60px)] lg:h-screen bg-neutral-950 lg:border-l border-neutral-900 ${mobileTab === 'routine' ? 'flex' : 'hidden lg:flex'}`}>
          
          <div className="px-4 py-3 border-b border-neutral-900 flex justify-between items-center bg-neutral-950 h-[60px] sticky top-0 z-20">
            <div>
              <p className="text-[9px] text-neutral-500 uppercase tracking-widest mb-0.5">Editando</p>
              <h1 className="text-lg font-black text-white uppercase leading-none truncate max-w-[150px]">{userData.name}</h1>
            </div>
            <div className="text-right flex items-center gap-2">
              <span className="text-xl font-mono font-bold">{routine.length}</span>
              <span className="text-[9px] text-neutral-500 uppercase">Ejercicios</span>
            </div>
          </div>

          <div className="flex-1 overflow-y-auto p-3 space-y-2 pb-24">
            {routine.length === 0 ? (
              <div className="h-full flex flex-col items-center justify-center text-neutral-800 space-y-3 opacity-60">
                <List size={40} />
                <p className="text-sm">Tu rutina está vacía.</p>
                <button onClick={() => setMobileTab('catalog')} className="text-xs underline text-neutral-500 lg:hidden">
                    Ir al catálogo
                </button>
              </div>
            ) : (
              routine.map((item, idx) => (
                <div key={item.uid} className="bg-black border border-neutral-900 rounded-lg p-3 flex gap-3 items-center">
                  <span className="font-mono text-neutral-700 text-sm w-5 text-center flex-shrink-0">{idx + 1}</span>
                  
                  <div className="flex-1 min-w-0">
                    <h3 className="font-bold text-white text-sm truncate">{item.name}</h3>
                    <p className="text-[10px] text-neutral-500 uppercase truncate">
                        {MUSCLE_GROUPS.find(g => g.id === item.muscle)?.name || item.muscle}
                    </p>
                  </div>
                  
                  {/* Inputs Compactos */}
                  <div className="flex gap-1.5 items-center">
                    {['sets', 'reps', 'rest'].map((field) => (
                      <div key={field} className="flex flex-col items-center">
                        <label className="text-[8px] text-neutral-600 uppercase mb-0.5">
                            {field === 'sets' ? 'S' : field === 'reps' ? 'R' : 'D'}
                        </label>
                        <input 
                          type="number" 
                          className="bg-neutral-900/50 w-8 h-7 text-center text-xs font-mono rounded text-white border border-neutral-800 focus:border-white outline-none"
                          value={item[field]}
                          onChange={(e) => updateRoutineItem(item.uid, field, e.target.value)}
                        />
                      </div>
                    ))}
                  </div>

                  <button 
                    onClick={() => removeFromRoutine(item.uid)}
                    className="text-neutral-600 hover:text-red-500 p-1.5"
                  >
                    <Trash2 size={16} />
                  </button>
                </div>
              ))
            )}
          </div>

          <div className="p-4 bg-black border-t border-neutral-900 fixed bottom-[60px] lg:bottom-0 left-0 w-full lg:w-1/2 lg:relative z-30">
            <button 
              disabled={routine.length === 0}
              onClick={() => setShowUnlockModal(true)}
              className="w-full bg-white disabled:bg-neutral-800 disabled:text-neutral-600 text-black font-bold py-3.5 rounded-xl hover:bg-neutral-200 transition-all flex items-center justify-center gap-2 shadow-lg text-sm"
            >
              <Lock size={16} /> FINALIZAR RUTINA
            </button>
          </div>
        </div>

        {/* --- BARRA DE NAVEGACIÓN INFERIOR (SÓLO MÓVIL) --- */}
        <div className="lg:hidden fixed bottom-0 left-0 w-full h-[60px] bg-neutral-950 border-t border-neutral-900 flex z-40">
            <button 
                onClick={() => setMobileTab('catalog')}
                className={`flex-1 flex flex-col items-center justify-center gap-1 ${mobileTab === 'catalog' ? 'text-white' : 'text-neutral-600'}`}
            >
                <LayoutGrid size={20} />
                <span className="text-[10px] uppercase font-bold tracking-wider">Catálogo</span>
            </button>
            <div className="w-[1px] bg-neutral-900 h-full"></div>
            <button 
                onClick={() => setMobileTab('routine')}
                className={`flex-1 flex flex-col items-center justify-center gap-1 ${mobileTab === 'routine' ? 'text-white' : 'text-neutral-600'}`}
            >
                <div className="relative">
                    <List size={20} />
                    {routine.length > 0 && (
                        <span className="absolute -top-1 -right-2 bg-white text-black text-[9px] font-bold w-3.5 h-3.5 flex items-center justify-center rounded-full">
                            {routine.length}
                        </span>
                    )}
                </div>
                <span className="text-[10px] uppercase font-bold tracking-wider">Mi Rutina</span>
            </button>
        </div>

        {/* MODAL CONFIGURACIÓN SEGURIDAD */}
        <Modal isOpen={showUnlockModal && step === 'builder'} onClose={() => setShowUnlockModal(false)} title="Bloquear Rutina">
          <p className="text-neutral-400 text-xs mb-4">Crea una contraseña para evitar modificaciones.</p>
          <form onSubmit={handleLock} className="space-y-4">
            <div>
              <label className="block text-[10px] uppercase text-neutral-500 mb-1">Contraseña</label>
              <input 
                type="password" 
                required
                className="w-full bg-black border border-neutral-800 rounded-lg p-3 text-white focus:border-white outline-none text-sm"
                value={userData.password}
                onChange={(e) => setUserData({...userData, password: e.target.value})}
              />
            </div>
            <div className="bg-neutral-900/50 p-3 rounded-lg border border-neutral-800">
              <div className="mb-3">
                  <label className="block text-[10px] uppercase text-neutral-500 mb-1">Pregunta Seguridad</label>
                  <select 
                      required
                      className="w-full bg-black border border-neutral-800 rounded-lg p-2 text-white text-sm focus:border-white outline-none appearance-none"
                      value={userData.securityQuestion}
                      onChange={(e) => setUserData({...userData, securityQuestion: e.target.value})}
                  >
                      <option value="">Selecciona...</option>
                      <option value="pet">¿Primera mascota?</option>
                      <option value="city">¿Ciudad nacimiento?</option>
                      <option value="hero">¿Héroe infancia?</option>
                  </select>
              </div>
              <div>
                  <label className="block text-[10px] uppercase text-neutral-500 mb-1">Respuesta</label>
                  <input 
                      type="text" 
                      required
                      className="w-full bg-black border border-neutral-800 rounded-lg p-2 text-white text-sm focus:border-white outline-none"
                      value={userData.securityAnswer}
                      onChange={(e) => setUserData({...userData, securityAnswer: e.target.value})}
                  />
              </div>
            </div>
            <button type="submit" className="w-full bg-white text-black font-bold py-3 rounded-lg hover:bg-neutral-200 mt-2 text-sm">
              BLOQUEAR
            </button>
          </form>
        </Modal>
      </div>
    );
  }

  // 3. WORKOUT PLAYER (MODO ASISTENTE)
  const WorkoutPlayer = () => {
    // Estado del asistente
    const [currentExerciseIdx, setCurrentExerciseIdx] = useState(0);
    const [currentSet, setCurrentSet] = useState(1);
    const [timer, setTimer] = useState(0);
    const [isResting, setIsResting] = useState(false);
    const [muted, setMuted] = useState(false);
    const [hasStarted, setHasStarted] = useState(false);

    const activeExercise = routine[currentExerciseIdx];
    const isFinished = currentExerciseIdx >= routine.length;

    // Efecto para el inicio de la sesión
    useEffect(() => {
        if (!hasStarted && !isFinished && activeExercise) {
            setHasStarted(true);
            const text = `Iniciando entrenamiento. Primer ejercicio: ${activeExercise.name}. ${activeExercise.sets} series de ${activeExercise.reps} repeticiones.`;
            if(!muted) speak(text);
        }
    }, [hasStarted, isFinished, activeExercise, muted]);

    // Lógica del Temporizador y Transiciones Automáticas
    useEffect(() => {
      let interval;
      if (isResting && timer > 0) {
        interval = setInterval(() => setTimer(t => t - 1), 1000);
      } else if (isResting && timer === 0) {
        // FIN DEL DESCANSO
        setIsResting(false);
        
        if (currentSet < parseInt(activeExercise.sets)) {
            // Siguiente Serie del mismo ejercicio
            const nextSet = currentSet + 1;
            setCurrentSet(nextSet);
            if(!muted) speak(`Descanso terminado. Serie ${nextSet}. Haz ${activeExercise.reps} repeticiones.`);
        } else {
            // Siguiente Ejercicio
            const nextIdx = currentExerciseIdx + 1;
            if (nextIdx < routine.length) {
                setCurrentExerciseIdx(nextIdx);
                setCurrentSet(1);
                const nextEx = routine[nextIdx];
                if(!muted) speak(`Ejercicio completado. Siguiente: ${nextEx.name}. ${nextEx.sets} series de ${nextEx.reps} repeticiones.`);
            } else {
                // Fin de Rutina
                setCurrentExerciseIdx(nextIdx); // Trigger finish screen
                if(!muted) speak("Entrenamiento finalizado. ¡Excelente trabajo!");
            }
        }
      }
      return () => clearInterval(interval);
    }, [isResting, timer, currentSet, currentExerciseIdx, activeExercise, muted]);

    const handleCompleteSet = () => {
        // Iniciar Descanso
        setIsResting(true);
        const restTime = parseInt(activeExercise.rest);
        setTimer(restTime);
        if(!muted) speak(`Serie completada. Descansa ${restTime} segundos.`);
    };

    const skipRest = () => {
        setTimer(0);
    };

    const formatTime = (secs) => `${Math.floor(secs / 60)}:${(secs % 60).toString().padStart(2, '0')}`;

    // Pantalla de Finalización
    if (isFinished) {
        return (
            <div className="fixed inset-0 bg-black z-50 flex flex-col items-center justify-center p-6 text-center animate-in zoom-in duration-300">
                <div className="w-24 h-24 bg-white rounded-full flex items-center justify-center text-black mb-6 shadow-[0_0_30px_rgba(255,255,255,0.3)]">
                    <CheckCircle2 size={48} />
                </div>
                <h2 className="text-4xl font-black text-white mb-2">¡RUTINA COMPLETADA!</h2>
                <p className="text-neutral-400 mb-8">Has terminado todos los ejercicios.</p>
                <button onClick={() => setWorkoutActive(false)} className="bg-white text-black px-8 py-4 rounded-xl font-bold">
                    VOLVER AL MENÚ
                </button>
            </div>
        );
    }

    return (
        <div className="fixed inset-0 bg-black z-50 flex flex-col animate-in slide-in-from-bottom duration-300">
            {/* Header */}
            <div className="px-4 py-3 border-b border-neutral-900 flex justify-between items-center bg-neutral-950">
                <div className="flex items-center gap-2">
                    <span className="relative flex h-2.5 w-2.5">
                      <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span className="relative inline-flex rounded-full h-2.5 w-2.5 bg-green-500"></span>
                    </span>
                    <h2 className="font-bold text-white tracking-wider text-sm">ASISTENTE ACTIVO</h2>
                </div>
                <div className="flex gap-2">
                    <button onClick={() => setMuted(!muted)} className="bg-neutral-900 hover:bg-neutral-800 p-1.5 rounded-full transition-colors text-white">
                        {muted ? <VolumeX size={18} /> : <Volume2 size={18} />}
                    </button>
                    <button onClick={() => setWorkoutActive(false)} className="bg-neutral-900 hover:bg-neutral-800 p-1.5 rounded-full transition-colors text-white">
                        <X size={18} />
                    </button>
                </div>
            </div>

            {/* Contenido Principal */}
            <div className="flex-1 flex flex-col p-6 relative">
                
                {/* Progreso General */}
                <div className="flex justify-between text-xs text-neutral-500 uppercase tracking-widest mb-2">
                    <span>Ejercicio {currentExerciseIdx + 1} de {routine.length}</span>
                    <span>Progreso Total: {Math.round(((currentExerciseIdx) / routine.length) * 100)}%</span>
                </div>
                <div className="w-full bg-neutral-900 h-1 rounded-full mb-8">
                    <div 
                        className="bg-green-500 h-1 rounded-full transition-all duration-500" 
                        style={{ width: `${((currentExerciseIdx) / routine.length) * 100}%` }}
                    ></div>
                </div>

                {/* Tarjeta de Ejercicio Actual */}
                <div className="flex-1 flex flex-col items-center justify-center text-center">
                    <div className="mb-6">
                        <span className="text-[10px] uppercase font-bold bg-neutral-800 text-neutral-400 px-3 py-1 rounded-full border border-neutral-700">
                            {MUSCLE_GROUPS.find(g => g.id === activeExercise.muscle)?.name || activeExercise.muscle}
                        </span>
                    </div>
                    
                    <h1 className="text-3xl md:text-5xl font-black text-white mb-4 leading-tight">{activeExercise.name}</h1>
                    <p className="text-neutral-400 text-sm md:text-base max-w-md mx-auto mb-10">{activeExercise.description}</p>

                    {/* Stats Grandes */}
                    <div className="grid grid-cols-2 gap-4 w-full max-w-sm mb-10">
                        <div className="bg-neutral-900 border border-neutral-800 p-4 rounded-2xl flex flex-col items-center">
                            <span className="text-xs text-neutral-500 uppercase tracking-widest mb-1">Serie Actual</span>
                            <div className="flex items-baseline gap-1">
                                <span className="text-4xl font-bold text-white">{currentSet}</span>
                                <span className="text-lg text-neutral-600">/ {activeExercise.sets}</span>
                            </div>
                        </div>
                        <div className="bg-neutral-900 border border-neutral-800 p-4 rounded-2xl flex flex-col items-center">
                            <span className="text-xs text-neutral-500 uppercase tracking-widest mb-1">Objetivo</span>
                            <div className="flex items-baseline gap-1">
                                <span className="text-4xl font-bold text-white">{activeExercise.reps}</span>
                                <span className="text-lg text-neutral-600">Reps</span>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Botón de Acción Principal */}
                <button 
                    onClick={handleCompleteSet}
                    className="w-full bg-white text-black font-black text-lg py-5 rounded-2xl hover:bg-neutral-200 transition-transform active:scale-95 shadow-[0_0_20px_rgba(255,255,255,0.2)] flex items-center justify-center gap-3 mb-6"
                >
                    <CheckCircle2 size={24} fill="black" className="text-white" />
                    COMPLETAR SERIE
                </button>
            </div>

            {/* Overlay de Descanso (Sólo visible cuando isResting es true) */}
            {isResting && (
                <div className="absolute inset-0 bg-black/95 backdrop-blur-md z-20 flex flex-col items-center justify-center p-6 animate-in fade-in duration-200">
                    <p className="text-sm uppercase tracking-[0.3em] text-neutral-400 mb-8 animate-pulse">Recuperación</p>
                    
                    <div className="relative mb-12">
                        {/* Círculo decorativo */}
                        <div className="w-64 h-64 rounded-full border-4 border-neutral-800 flex items-center justify-center">
                             <div className="w-56 h-56 rounded-full border-2 border-green-500/20 flex items-center justify-center animate-pulse">
                                 <h2 className="text-8xl font-mono font-bold text-white tabular-nums tracking-tighter">
                                    {timer}
                                 </h2>
                             </div>
                        </div>
                    </div>

                    <p className="text-neutral-500 mb-2">Siguiente:</p>
                    <h3 className="text-xl font-bold text-white mb-8">
                        {currentSet < parseInt(activeExercise.sets) 
                            ? `Serie ${currentSet + 1} - ${activeExercise.reps} Reps`
                            : routine[currentExerciseIdx + 1] 
                                ? `Prox: ${routine[currentExerciseIdx + 1].name}` 
                                : "¡Último esfuerzo!"
                        }
                    </h3>

                    <button 
                        onClick={skipRest}
                        className="bg-neutral-800 hover:bg-neutral-700 text-white px-8 py-3 rounded-full font-bold flex items-center gap-2 transition-colors"
                    >
                        <SkipForward size={18} /> SALTAR DESCANSO
                    </button>
                </div>
            )}
        </div>
    );
  };

  // 4. LOCKED VIEW (MODO USO)
  if (step === 'locked') {
    return (
      <div className="min-h-screen bg-black text-white selection:bg-white selection:text-black">
        {workoutActive && <WorkoutPlayer />}

        <header className="fixed top-0 w-full z-30 bg-black/90 backdrop-blur-md border-b border-neutral-900 px-4 py-3 flex justify-between items-center h-[60px]">
             <div className="flex items-center gap-3">
                 <div className="w-8 h-8 bg-white rounded-lg flex items-center justify-center text-black font-black text-xs">
                     {userData.name.charAt(0).toUpperCase()}
                 </div>
                 <div className="leading-none">
                    <p className="text-[9px] uppercase tracking-widest text-neutral-500">Rutina de</p>
                    <p className="font-bold text-sm">{userData.name}</p>
                 </div>
             </div>
             <button 
                onClick={() => setShowUnlockModal(true)}
                className="w-9 h-9 rounded-full bg-neutral-900 hover:bg-neutral-800 flex items-center justify-center transition-colors text-neutral-400 hover:text-white"
             >
                 <Settings size={16} />
             </button>
        </header>

        <main className="pt-20 px-4 max-w-xl mx-auto pb-24 animate-in fade-in duration-500">
            <div className="flex flex-col gap-4 mb-8">
                <div>
                    <h1 className="text-3xl font-black mb-1 uppercase tracking-tighter">Mi Plan</h1>
                    <div className="flex gap-3 text-xs text-neutral-400">
                        <span className="flex items-center gap-1"><ShieldCheck size={12} className="text-green-500"/> Protegido</span>
                        <span>•</span>
                        <span>{routine.length} Ejercicios</span>
                    </div>
                </div>
                <button 
                    onClick={() => setWorkoutActive(true)}
                    className="bg-white text-black px-6 py-3.5 rounded-xl font-bold text-sm hover:bg-neutral-200 transition-all shadow-lg flex items-center justify-center gap-2 w-full"
                >
                    <Play size={18} fill="black" />
                    EMPEZAR SESIÓN
                </button>
            </div>

            <div className="space-y-3">
                {routine.map((item, index) => (
                    <div key={item.uid} className="bg-neutral-900/40 border border-neutral-900 rounded-lg p-4 flex items-center gap-4 hover:border-neutral-700 transition-all">
                        <span className="font-mono text-xl font-bold text-neutral-800 w-6 text-center">
                            {(index + 1)}
                        </span>
                        <div className="flex-1 min-w-0">
                            <h3 className="text-base font-bold text-white mb-1 truncate">{item.name}</h3>
                            <div className="flex flex-wrap gap-1.5">
                                <span className="text-[9px] uppercase font-bold bg-neutral-950 px-1.5 py-0.5 rounded text-neutral-500 border border-neutral-800">{item.sets} X {item.reps}</span>
                                <span className="text-[9px] uppercase font-bold bg-neutral-950 px-1.5 py-0.5 rounded text-neutral-500 border border-neutral-800">{item.rest}s</span>
                            </div>
                        </div>
                        <div className="w-6 h-6 rounded-full border border-neutral-800 flex items-center justify-center text-neutral-800">
                            <CheckCircle2 size={12} />
                        </div>
                    </div>
                ))}
            </div>
        </main>

        {/* Modal Desbloqueo */}
        <Modal isOpen={showUnlockModal} onClose={() => setShowUnlockModal(false)} title="Acceso">
            <form onSubmit={handleUnlock} className="space-y-4">
                <div className="text-center py-2">
                    <p className="text-neutral-500 text-xs">Ingresa tu contraseña.</p>
                </div>
                
                <input 
                    type="password" 
                    placeholder="••••"
                    className="w-full bg-black border border-neutral-800 rounded-lg p-3 text-white focus:border-white outline-none text-center text-lg tracking-widest transition-colors"
                    value={tempPassword}
                    onChange={(e) => setTempPassword(e.target.value)}
                    autoFocus
                />
                
                <button type="submit" className="w-full bg-white text-black font-bold py-3.5 rounded-lg hover:bg-neutral-200 transition-colors text-sm">
                    DESBLOQUEAR
                </button>

                <button 
                    type="button"
                    onClick={() => { setShowUnlockModal(false); setShowRecoveryModal(true); }}
                    className="w-full text-[10px] text-neutral-500 hover:text-white transition-colors mt-2"
                >
                    Recuperar contraseña
                </button>
            </form>
        </Modal>

        {/* Modal Recuperación */}
        <Modal isOpen={showRecoveryModal} onClose={() => setShowRecoveryModal(false)} title="Recuperar">
             <form onSubmit={handleRecovery} className="space-y-4">
                <div className="p-3 bg-neutral-900 rounded-lg border border-neutral-800">
                    <p className="text-[9px] text-neutral-500 uppercase tracking-widest mb-1">Pregunta</p>
                    <p className="text-white text-sm font-medium">
                        {userData.securityQuestion === 'pet' && "¿Nombre de tu primera mascota?"}
                        {userData.securityQuestion === 'city' && "¿Ciudad de nacimiento?"}
                        {userData.securityQuestion === 'hero' && "¿Héroe de la infancia?"}
                    </p>
                </div>
                
                <div>
                    <label className="block text-[10px] uppercase text-neutral-500 mb-1">Respuesta</label>
                    <input 
                        type="text" 
                        className="w-full bg-black border border-neutral-800 rounded-lg p-3 text-white focus:border-white outline-none transition-colors text-sm"
                        value={tempSecurityAnswer}
                        onChange={(e) => setTempSecurityAnswer(e.target.value)}
                    />
                </div>
                
                <button type="submit" className="w-full bg-white text-black font-bold py-3.5 rounded-lg hover:bg-neutral-200 transition-colors text-sm">
                    RESTABLECER
                </button>
            </form>
        </Modal>
      </div>
    );
  }

  return null;
}


