<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trainer Pro</title>
    
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2964/2964514.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2964/2964514.png">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { background-color: #000; color: white; -webkit-tap-highlight-color: transparent; }
        /* Animaciones simples */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        /* Corrección inputs móvil */
        input, select { font-size: 16px !important; }
        #error-log { display: none; padding: 20px; color: #ff5555; font-family: monospace; background: #220000; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; overflow: auto; }
    </style>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            document.getElementById('loading-msg').style.display = 'none';
            var errorBox = document.getElementById('error-log');
            errorBox.style.display = 'block';
            errorBox.innerHTML += "<h3>Error Detectado:</h3><p>" + message + "</p><p>Línea: " + lineno + "</p>";
        };
    </script>
</head>
<body>

    <div id="loading-msg" class="flex h-screen w-full items-center justify-center flex-col gap-4">
        <div class="w-8 h-8 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
        <p class="text-neutral-500 text-sm font-mono">Iniciando sistema...</p>
    </div>

    <div id="root"></div>
    
    <div id="error-log"></div>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel" data-type="module">
        // Importaciones Directas (Más seguras para móvil)
        import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Dumbbell, Lock, Play, Plus, Trash2, CheckCircle2, 
            Settings, X, ChevronRight, ShieldCheck, Timer, Pause, 
            ArrowLeft, Search, Layers, Activity, Zap, Monitor, 
            LayoutGrid, List, Volume2, VolumeX, SkipForward
        } from 'https://esm.sh/lucide-react@0.263.1';

        // --- DATA ---
        const EXERCISE_CATALOG = [
          { id: 'ch1', name: 'Flexiones Clásicas', muscle: 'chest', difficulty: 'Intermedio', description: 'Manos a la anchura de los hombros. Cuerpo recto.' },
          { id: 'ch2', name: 'Flexiones Diamante', muscle: 'chest', difficulty: 'Avanzado', description: 'Manos juntas en diamante. Enfoque tríceps.' },
          { id: 'ch3', name: 'Flexiones Inclinadas', muscle: 'chest', difficulty: 'Principiante', description: 'Manos en superficie elevada.' },
          { id: 'bk1', name: 'Dominadas', muscle: 'back', difficulty: 'Avanzado', description: 'Sube barbilla sobre la barra.' },
          { id: 'bk3', name: 'Remo Invertido', muscle: 'back', difficulty: 'Intermedio', description: 'Bajo una mesa, tracciona el pecho.' },
          { id: 'lg1', name: 'Sentadilla', muscle: 'legs', difficulty: 'Principiante', description: 'Baja cadera atrás. Espalda recta.' },
          { id: 'lg2', name: 'Zancadas', muscle: 'legs', difficulty: 'Intermedio', description: 'Paso al frente, baja rodilla trasera.' },
          { id: 'sh1', name: 'Flexiones Pike', muscle: 'shoulders', difficulty: 'Intermedio', description: 'Cuerpo en V invertida.' },
          { id: 'ar1', name: 'Fondos Tríceps', muscle: 'arms', difficulty: 'Principiante', description: 'Manos en silla tras ti.' },
          { id: 'co1', name: 'Plancha', muscle: 'core', difficulty: 'Intermedio', description: 'Cuerpo recto y tenso.' },
          { id: 'ca1', name: 'Burpees', muscle: 'cardio', difficulty: 'Avanzado', description: 'Sentadilla -> Plancha -> Salto.' }
        ];

        const MUSCLE_GROUPS = [
          { id: 'chest', name: 'Pecho', icon: Activity, desc: 'Empuje' },
          { id: 'back', name: 'Espalda', icon: Layers, desc: 'Tracción' },
          { id: 'legs', name: 'Piernas', icon: LayoutGrid, desc: 'Potencia' },
          { id: 'shoulders', name: 'Hombros', icon: Dumbbell, desc: 'Deltoides' },
          { id: 'arms', name: 'Brazos', icon: Zap, desc: 'Bíceps/Tríceps' },
          { id: 'core', name: 'Abdomen', icon: ShieldCheck, desc: 'Core' },
          { id: 'cardio', name: 'Cardio', icon: Activity, desc: 'Quema' },
        ];

        // --- COMPONENTES ---

        const Modal = ({ isOpen, onClose, title, children }) => {
          if (!isOpen) return null;
          return (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate-in">
              <div className="w-full max-w-sm bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl">
                <div className="flex justify-between items-center p-4 border-b border-neutral-800">
                  <h3 className="text-base font-bold text-white tracking-tight">{title}</h3>
                  <button onClick={onClose} className="text-neutral-500 hover:text-white">
                    <X size={20} />
                  </button>
                </div>
                <div className="p-4">{children}</div>
              </div>
            </div>
          );
        };

        const speak = (text) => {
            if (!('speechSynthesis' in window)) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'es-ES';
            window.speechSynthesis.speak(utterance);
        };

        function App() {
          const [step, setStep] = useState('loading'); 
          const [userData, setUserData] = useState({ name: '', password: '', securityQuestion: '', securityAnswer: '' });
          const [routine, setRoutine] = useState([]);
          
          const [showUnlockModal, setShowUnlockModal] = useState(false);
          const [showRecoveryModal, setShowRecoveryModal] = useState(false);
          const [workoutActive, setWorkoutActive] = useState(false);
          
          const [mobileTab, setMobileTab] = useState('catalog');
          const [builderCategory, setBuilderCategory] = useState(null); 
          const [searchQuery, setSearchQuery] = useState('');
          
          const [tempPassword, setTempPassword] = useState('');
          const [tempSecurityAnswer, setTempSecurityAnswer] = useState('');

          // Carga inicial segura
          useEffect(() => {
            try {
                const savedData = localStorage.getItem('fit_app_mobile_v6_data');
                if (savedData) {
                  const parsed = JSON.parse(savedData);
                  setUserData(parsed.userData || { name: '' });
                  setRoutine(parsed.routine || []);
                  if (parsed.userData?.password) setStep('locked');
                  else if (parsed.userData?.name) setStep('builder');
                  else setStep('onboarding');
                } else {
                  setStep('onboarding');
                }
            } catch (e) {
                console.error("Error cargando datos", e);
                setStep('onboarding');
            }
            
            // Ocultar loader HTML
            const loader = document.getElementById('loading-msg');
            if(loader) loader.style.display = 'none';
          }, []);

          // Guardado automático
          useEffect(() => {
            if (userData.name) {
              localStorage.setItem('fit_app_mobile_v6_data', JSON.stringify({ userData, routine }));
            }
          }, [userData, routine]);

          const addToRoutine = (exercise) => {
            const newItem = { ...exercise, uid: Date.now(), sets: 4, reps: 12, rest: 60 };
            setRoutine([...routine, newItem]);
            if (window.navigator?.vibrate) navigator.vibrate(50);
          };

          const removeFromRoutine = (uid) => setRoutine(routine.filter(item => item.uid !== uid));

          const updateRoutineItem = (uid, field, value) => {
            setRoutine(routine.map(item => item.uid === uid ? { ...item, [field]: value } : item));
          };

          const handleLock = (e) => {
            e.preventDefault();
            if (userData.password) {
              setStep('locked');
              setBuilderCategory(null);
            }
          };

          const handleUnlock = (e) => {
            e.preventDefault();
            if (tempPassword === userData.password) {
              setStep('builder');
              setShowUnlockModal(false);
              setTempPassword('');
            } else {
              alert("Contraseña incorrecta");
            }
          };

          const handleRecovery = (e) => {
            e.preventDefault();
            if (tempSecurityAnswer.toLowerCase().trim() === userData.securityAnswer.toLowerCase().trim()) {
                const newPass = prompt("Nueva contraseña:");
                if(newPass) {
                    setUserData({...userData, password: newPass});
                    alert("Actualizada");
                    setShowRecoveryModal(false);
                }
            } else {
                alert("Incorrecto");
            }
          };

          // --- VISTAS ---

          if (step === 'loading') return null;

          if (step === 'onboarding') {
            return (
              <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-gradient-to-b from-neutral-900 to-black">
                <div className="w-20 h-20 bg-white rounded-2xl flex items-center justify-center text-black mb-6 shadow-2xl">
                    <Monitor size={40} />
                </div>
                <h1 className="text-3xl font-black mb-2 uppercase">Trainer Pro</h1>
                <p className="text-neutral-500 mb-8 text-sm">Configura tu perfil.</p>
                <form onSubmit={(e) => { e.preventDefault(); if(userData.name) setStep('builder'); }} className="w-full max-w-xs space-y-4">
                    <input type="text" placeholder="Tu nombre" className="w-full bg-neutral-900 border border-neutral-800 rounded-xl p-4 text-white outline-none focus:border-white" value={userData.name} onChange={e => setUserData({...userData, name: e.target.value})} required />
                    <button className="w-full bg-white text-black font-bold py-4 rounded-xl flex justify-center items-center gap-2">EMPEZAR <ChevronRight size={18}/></button>
                </form>
              </div>
            );
          }

          if (step === 'builder') {
            return (
              <div className="flex flex-col h-screen pb-[60px] bg-black">
                {/* Header / Buscador */}
                <div className="p-3 border-b border-neutral-900 bg-neutral-950 flex items-center gap-2 sticky top-0 z-10">
                    {builderCategory && <button onClick={() => setBuilderCategory(null)} className="p-2 bg-neutral-900 rounded-full"><ArrowLeft size={16}/></button>}
                    <div className="flex-1 relative">
                        <Search className="absolute left-3 top-2.5 text-neutral-500" size={14}/>
                        <input type="text" placeholder="Buscar..." className="w-full bg-neutral-900 rounded-full pl-9 pr-3 py-2 text-xs text-white outline-none focus:border-white border border-transparent" value={searchQuery} onChange={e => setSearchQuery(e.target.value)}/>
                    </div>
                </div>

                {/* Contenido Principal */}
                <div className={`flex-1 overflow-y-auto p-3 ${mobileTab === 'routine' ? 'hidden' : 'block'}`}>
                    {!builderCategory && !searchQuery ? (
                        <div className="grid grid-cols-2 gap-2">
                            {MUSCLE_GROUPS.map(g => (
                                <button key={g.id} onClick={() => setBuilderCategory(g.id)} className="bg-neutral-900/50 border border-neutral-900 p-4 rounded-xl flex flex-col items-center gap-2 active:bg-neutral-800">
                                    <g.icon size={24} className="text-neutral-400"/>
                                    <span className="font-bold text-sm">{g.name}</span>
                                </button>
                            ))}
                        </div>
                    ) : (
                        <div className="space-y-2 pb-20">
                            {EXERCISE_CATALOG.filter(ex => searchQuery ? ex.name.toLowerCase().includes(searchQuery.toLowerCase()) : ex.muscle === builderCategory).map(ex => (
                                <div key={ex.id} className="bg-neutral-900/40 border border-neutral-900 p-3 rounded-lg flex items-center justify-between gap-3">
                                    <div className="min-w-0">
                                        <h3 className="font-bold text-sm truncate">{ex.name}</h3>
                                        <span className="text-[10px] bg-neutral-800 px-1.5 rounded text-neutral-400">{ex.difficulty}</span>
                                    </div>
                                    <button onClick={() => addToRoutine(ex)} className="w-8 h-8 bg-white text-black rounded-full flex items-center justify-center flex-shrink-0 active:scale-90"><Plus size={18}/></button>
                                </div>
                            ))}
                        </div>
                    )}
                </div>

                {/* Vista Rutina */}
                <div className={`flex-1 overflow-y-auto p-3 space-y-2 ${mobileTab === 'routine' ? 'block' : 'hidden'}`}>
                    {routine.length === 0 && <div className="text-center text-neutral-500 mt-10 text-sm">Rutina vacía. Agrega ejercicios del catálogo.</div>}
                    {routine.map((item, idx) => (
                        <div key={item.uid} className="bg-neutral-900 border border-neutral-800 p-3 rounded-lg flex items-center gap-2">
                            <span className="font-mono text-neutral-500 w-4 text-center text-xs">{idx+1}</span>
                            <div className="flex-1 min-w-0 truncate"><h3 className="text-sm font-bold truncate">{item.name}</h3></div>
                            <div className="flex gap-1">
                                <input type="number" className="w-8 h-8 bg-black text-center text-xs rounded border border-neutral-800 text-white" value={item.sets} onChange={(e) => updateRoutineItem(item.uid, 'sets', e.target.value)} />
                                <input type="number" className="w-8 h-8 bg-black text-center text-xs rounded border border-neutral-800 text-white" value={item.reps} onChange={(e) => updateRoutineItem(item.uid, 'reps', e.target.value)} />
                            </div>
                            <button onClick={() => removeFromRoutine(item.uid)} className="p-2 text-neutral-600"><Trash2 size={16}/></button>
                        </div>
                    ))}
                    {routine.length > 0 && (
                        <button onClick={() => setShowUnlockModal(true)} className="w-full bg-white text-black font-bold py-3 rounded-xl mt-4 flex items-center justify-center gap-2 text-sm"><Lock size={16}/> FINALIZAR</button>
                    )}
                </div>

                {/* Barra Inferior */}
                <div className="fixed bottom-0 w-full h-[60px] bg-neutral-950 border-t border-neutral-900 flex">
                    <button onClick={() => setMobileTab('catalog')} className={`flex-1 flex flex-col items-center justify-center gap-1 ${mobileTab === 'catalog' ? 'text-white' : 'text-neutral-600'}`}>
                        <LayoutGrid size={20}/>
                        <span className="text-[10px] font-bold uppercase">Catálogo</span>
                    </button>
                    <button onClick={() => setMobileTab('routine')} className={`flex-1 flex flex-col items-center justify-center gap-1 ${mobileTab === 'routine' ? 'text-white' : 'text-neutral-600'}`}>
                        <div className="relative"><List size={20}/>{routine.length > 0 && <span className="absolute -top-1 -right-2 bg-white text-black text-[9px] w-3.5 h-3.5 flex items-center justify-center rounded-full font-bold">{routine.length}</span>}</div>
                        <span className="text-[10px] font-bold uppercase">Rutina</span>
                    </button>
                </div>

                {/* Modal Seguridad */}
                <Modal isOpen={showUnlockModal} onClose={() => setShowUnlockModal(false)} title="Bloquear">
                    <form onSubmit={handleLock} className="space-y-3">
                        <input type="password" required placeholder="Crea contraseña" className="w-full bg-black border border-neutral-800 p-3 rounded-lg text-white outline-none" value={userData.password} onChange={e => setUserData({...userData, password: e.target.value})}/>
                        <div className="p-3 bg-neutral-900 rounded-lg space-y-2">
                             <select className="w-full bg-black border border-neutral-800 p-2 rounded text-sm text-white" value={userData.securityQuestion} onChange={e => setUserData({...userData, securityQuestion: e.target.value})} required>
                                <option value="">Pregunta seguridad...</option>
                                <option value="pet">Mascota</option>
                                <option value="city">Ciudad</option>
                             </select>
                             <input type="text" required placeholder="Respuesta" className="w-full bg-black border border-neutral-800 p-2 rounded text-sm text-white" value={userData.securityAnswer} onChange={e => setUserData({...userData, securityAnswer: e.target.value})}/>
                        </div>
                        <button className="w-full bg-white text-black font-bold py-3 rounded-lg text-sm">GUARDAR Y BLOQUEAR</button>
                    </form>
                </Modal>
              </div>
            );
          }

          const WorkoutPlayer = () => {
             const [idx, setIdx] = useState(0);
             const [set, setSet] = useState(1);
             const [timer, setTimer] = useState(0);
             const [resting, setResting] = useState(false);
             const active = routine[idx];

             useEffect(() => {
                let i;
                if(resting && timer > 0) i = setInterval(() => setTimer(t=>t-1), 1000);
                else if(resting && timer === 0) {
                    setResting(false);
                    if(set < parseInt(active.sets)) setSet(s=>s+1);
                    else if(idx < routine.length -1) { setIdx(i=>i+1); setSet(1); }
                    else setIdx(i=>i+1); // Fin
                    speak("Siguiente serie");
                }
                return () => clearInterval(i);
             }, [resting, timer]);

             if(idx >= routine.length) return (
                 <div className="fixed inset-0 bg-black z-50 flex flex-col items-center justify-center p-6 text-center animate-in">
                    <CheckCircle2 size={60} className="text-white mb-4"/>
                    <h1 className="text-3xl font-black text-white">¡TERMINADO!</h1>
                    <button onClick={() => setWorkoutActive(false)} className="mt-8 bg-white text-black px-6 py-3 rounded-full font-bold">SALIR</button>
                 </div>
             );

             return (
                 <div className="fixed inset-0 bg-black z-50 flex flex-col animate-in">
                    <div className="p-4 bg-neutral-900 flex justify-between items-center">
                        <span className="font-bold text-sm text-green-400">EN PROGRESO</span>
                        <button onClick={() => setWorkoutActive(false)}><X size={20}/></button>
                    </div>
                    <div className="flex-1 flex flex-col items-center justify-center p-6 text-center">
                        <span className="text-xs uppercase text-neutral-500 mb-2">Ejercicio {idx+1}/{routine.length}</span>
                        <h2 className="text-4xl font-black mb-6">{active.name}</h2>
                        <div className="flex gap-4 mb-8">
                             <div className="bg-neutral-900 p-4 rounded-xl min-w-[100px]">
                                <p className="text-xs text-neutral-500 uppercase">Serie</p>
                                <p className="text-3xl font-bold">{set}<span className="text-lg text-neutral-600">/{active.sets}</span></p>
                             </div>
                             <div className="bg-neutral-900 p-4 rounded-xl min-w-[100px]">
                                <p className="text-xs text-neutral-500 uppercase">Reps</p>
                                <p className="text-3xl font-bold">{active.reps}</p>
                             </div>
                        </div>
                        <button onClick={() => { setResting(true); setTimer(parseInt(active.rest)); speak("Descansa"); }} className="w-full bg-white text-black font-bold py-4 rounded-xl flex items-center justify-center gap-2"><CheckCircle2/> COMPLETAR SERIE</button>
                    </div>
                    {resting && (
                        <div className="absolute inset-0 bg-black/95 flex flex-col items-center justify-center z-50">
                            <p className="uppercase tracking-widest text-neutral-500 mb-4 animate-pulse">Descanso</p>
                            <h2 className="text-9xl font-mono font-bold mb-8">{timer}</h2>
                            <button onClick={() => setTimer(0)} className="bg-neutral-800 px-6 py-2 rounded-full flex gap-2 items-center text-sm"><SkipForward size={16}/> SALTAR</button>
                        </div>
                    )}
                 </div>
             )
          }

          if (step === 'locked') {
            return (
              <div className="min-h-screen bg-black pb-20">
                {workoutActive && <WorkoutPlayer />}
                <div className="p-4 flex justify-between items-center bg-black/80 sticky top-0 backdrop-blur-md border-b border-neutral-900 z-10">
                    <div><p className="text-[10px] text-neutral-500 uppercase">Usuario</p><p className="font-bold">{userData.name}</p></div>
                    <button onClick={() => setShowUnlockModal(true)} className="p-2 bg-neutral-900 rounded-full"><Settings size={18} className="text-neutral-400"/></button>
                </div>
                <div className="p-4 space-y-4">
                    <div className="bg-neutral-900/50 p-6 rounded-2xl border border-neutral-900 text-center">
                        <h2 className="text-2xl font-black uppercase mb-2">Tu Rutina</h2>
                        <p className="text-neutral-500 text-sm mb-4">{routine.length} Ejercicios configurados</p>
                        <button onClick={() => setWorkoutActive(true)} className="w-full bg-white text-black font-bold py-3 rounded-xl flex justify-center items-center gap-2 shadow-lg hover:scale-105 transition-transform"><Play size={20} fill="black"/> COMENZAR</button>
                    </div>
                    <div className="space-y-2">
                        {routine.map((item, i) => (
                            <div key={i} className="bg-neutral-900/30 border border-neutral-900 p-4 rounded-xl flex items-center gap-4">
                                <span className="font-mono text-xl font-bold text-neutral-700">{i+1}</span>
                                <div>
                                    <h3 className="font-bold text-sm">{item.name}</h3>
                                    <p className="text-xs text-neutral-500">{item.sets} series x {item.reps} reps</p>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>

                <Modal isOpen={showUnlockModal} onClose={() => setShowUnlockModal(false)} title="Desbloquear">
                    <form onSubmit={handleUnlock} className="space-y-3">
                        <input type="password" autoFocus className="w-full bg-black border border-neutral-800 p-4 rounded-lg text-center text-xl tracking-widest text-white outline-none" placeholder="••••" value={tempPassword} onChange={e => setTempPassword(e.target.value)}/>
                        <button className="w-full bg-white text-black font-bold py-3 rounded-lg">ENTRAR</button>
                        <button type="button" onClick={() => {setShowUnlockModal(false); setShowRecoveryModal(true)}} className="w-full text-xs text-neutral-500 py-2">Olvidé la contraseña</button>
                    </form>
                </Modal>
                <Modal isOpen={showRecoveryModal} onClose={() => setShowRecoveryModal(false)} title="Recuperar">
                    <form onSubmit={handleRecovery} className="space-y-3">
                        <div className="p-3 bg-neutral-900 rounded mb-2"><span className="text-xs text-neutral-500 uppercase">Pregunta:</span><p>{userData.securityQuestion === 'pet' ? 'Mascota' : 'Ciudad'}</p></div>
                        <input type="text" className="w-full bg-black border border-neutral-800 p-3 rounded text-white" placeholder="Respuesta" value={tempSecurityAnswer} onChange={e => setTempSecurityAnswer(e.target.value)}/>
                        <button className="w-full bg-white text-black font-bold py-3 rounded-lg">RESTABLECER</button>
                    </form>
                </Modal>
              </div>
            );
          }

          return null;
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
